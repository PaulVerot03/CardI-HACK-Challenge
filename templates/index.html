<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Training Interface</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 2em; background-color: #f4f4f9; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        h1, h2 { color: #444; border-bottom: 1px solid #eee; padding-bottom: 0.3em; margin-top: 1.5em; }
        .form-group { margin-bottom: 1em; }
        label { display: block; margin-bottom: .5em; font-weight: bold; }
        input[type="number"], input[type="file"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .file-list { list-style-type: none; padding: 0; }
        .file-list li { margin-bottom: 0.5em; background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .file-list a { text-decoration: none; color: #007bff; }
        .status, .data-status-item { padding: 1em; border-radius: 4px; margin-bottom: 1em; font-weight: bold; }
        .running { background-color: #e7f7e7; color: #2d6a2d; border: 1px solid #b7e4b7; }
        .stopped { background-color: #fdeeee; color: #b94a48; border: 1px solid #f8d7da; }
        .found { color: #2d6a2d; }
        .missing { color: #b94a48; }
        #log-output { background: #1e1e1e; color: #d4d4d4; padding: 1em; border-radius: 4px; height: 400px; overflow-y: scroll; white-space: pre-wrap; word-wrap: break-word; font-family: "Menlo", "Consolas", monospace; }
        .flashes { list-style: none; padding: 0; margin-bottom: 1em; }
        .flashes li { padding: 1em; border-radius: 4px; font-weight: bold; }
        .flashes .success { background-color: #e7f7e7; color: #2d6a2d; border: 1px solid #b7e4b7; }
        .flashes .danger { background-color: #fdeeee; color: #b94a48; border: 1px solid #f8d7da; }
        .flashes .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Model Training Control</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class=flashes>
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <h2>Data Management</h2>
        <div class="data-status">
            <div class="data-status-item">train.csv: 
                {% if train_csv_exists %}
                    <span class="found">Found</span>
                {% else %}
                    <span class="missing">Missing</span>
                {% endif %}
            </div>
            <div class="data-status-item">test.csv: 
                {% if test_csv_exists %}
                    <span class="found">Found</span>
                {% else %}
                    <span class="missing">Missing</span>
                {% endif %}
            </div>
        </div>
        <form action="/upload" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="train_csv">Upload train.csv:</label>
                <input type="file" id="train_csv" name="train_csv">
            </div>
            <div class="form-group">
                <label for="test_csv">Upload test.csv:</label>
                <input type="file" id="test_csv" name="test_csv">
            </div>
            <button type="submit">Upload Files</button>
        </form>

        <h2>Control Panel</h2>
        {% if is_running %}
            <div class="status running">Training is currently in progress...</div>
        {% else %}
            <div class="status stopped">Training is not running.</div>
        {% endif %}

        <form action="/train" method="post">
            <div class="form-group">
                <label for="n_estimators">n_estimators:</label>
                <input type="number" id="n_estimators" name="n_estimators" value="1000">
            </div>
            <div class="form-group">
                <label for="n_jobs">n_jobs (CPU cores):</label>
                <input type="number" id="n_jobs" name="n_jobs" value="2">
            </div>
            <button type="submit" {% if is_running or not train_csv_exists or not test_csv_exists %}disabled{% endif %}>Start Training</button>
        </form>

        <h2>Live Log</h2>
        <pre id="log-output"></pre>

        <h2>Output Files</h2>
        <h3>Logs</h3>
        <ul class="file-list">
            {% for file in log_files %}
                <li><a href="/view/{{ file.split('/')[-1] }}" target="_blank">{{ file.split('/')[-1] }}</a></li>
            {% else %}
                <li>No log files found.</li>
            {% endfor %}
        </ul>

        <h3>Submissions</h3>
        <ul class="file-list">
            {% for file in submission_files %}
                <li><a href="/view/{{ file.split('/')[-1] }}" target="_blank">{{ file.split('/')[-1] }}</a></li>
            {% else %}
                <li>No submission files found.</li>
            {% endfor %}
        </ul>
    </div>

    <script>
        const logOutput = document.getElementById('log-output');
        const isRunning = {{ is_running | tojson }};

        if (isRunning) {
            logOutput.textContent = "Connecting to live log stream...\n";
            const eventSource = new EventSource("/stream-logs");

            eventSource.onmessage = function(event) {
                const data = event.data.replace(/\\n/g, '\n');
                if (data.startsWith("[STREAM_END]")) {
                    logOutput.textContent += data + '\n';
                    logOutput.scrollTop = logOutput.scrollHeight;
                    eventSource.close();
                    setTimeout(() => window.location.reload(), 2000);
                } else if (data.startsWith("[STREAM_ERROR]")) {
                    logOutput.textContent += data + '\n';
                    eventSource.close();
                }
                else {
                    if (logOutput.textContent.startsWith("Connecting to live log stream...")) {
                        logOutput.textContent = "";
                    }
                    logOutput.textContent += data + '\n';
                    logOutput.scrollTop = logOutput.scrollHeight; // Auto-scroll
                }
            };

            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                logOutput.textContent += "Log stream connection closed or failed.\n";
                eventSource.close();
            };
        } else {
            logOutput.textContent = "No training process is currently running.";
        }
    </script>
</body>
</html>
